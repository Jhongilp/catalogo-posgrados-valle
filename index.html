<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.rawgit.com/Keyang/node-csvtojson/d41f44aa/browser/csvtojson.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap"
      rel="stylesheet"
    />
    <title>Document</title>

    <style>
      body,
      h1,
      h2 {
        margin: 0;
      }

      .main-wrapper {
        display: flex;
        flex-direction: column;
        padding: 20px;
        font-family: "Roboto", sans-serif;
      }

      main {
        display: grid;
        grid-template-columns: minmax(20%, 300px) 1fr;
        gap: 30px;
        margin-top: 30px;
      }
      /* MENU */
      .menu {
        background-color: blueviolet;
        width: 100%;
      }

      .menu > ul {
        display: flex;
        flex-direction: column;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      .menu > ul li {
        display: flex;
        width: 100%;
        height: 35px;
        align-items: center;
        padding-left: 20px;
      }

      /*  */
      .content {
        display: flex;
        height: calc(100vh - 200px);
        overflow: auto;
      }

      .content-module {
        width: 100%;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      thead {
        height: 40px;
      }

      tr {
        height: 30px;
      }

      th,
      td {
        border-bottom: 1px solid #9e9e9e;
        padding: 0 4px;
      }

      .tb-programs_th {
        width: 150px;
      }
      .tb-programs-td--counter {
        text-align: center;
      }

      .menu-program-type-level {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 40px;
        padding: 0;
        margin: 20px 0;
      }
      .menu-program-type-level li {
        display: flex;
        height: 35px;
        align-items: center;
        padding: 0 20px;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        text-transform: uppercase;
      }
      .menu-program-type-level li:hover {
        background-color: #eee;
      }

      .menu-program-type-level li.selected {
        font-weight: bold;
        border-bottom: 2px solid black;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import {
        html,
        Component,
        render,
        useState,
        useEffect,
        useRef,
        createContext,
        useContext,
      } from "https://unpkg.com/htm/preact/standalone.module.js";

      const MainContext = createContext({});

      const NIVEL_FORMACION = {
        todos: "Todos",
        especializacion: "Especialización",
        maestria: "Maestría",
        doctorado: "Doctorado",
      };

      const initialFiltersState = {
        university: null,
        program_type: null,
        interest_area: null,
        modalidad: null,
        location: null,
      };

      function useFetchData() {
        const [data, setData] = useState([]);
        useEffect(() => {
          const url =
            "https://docs.google.com/spreadsheets/d/1wie8UTZ4KSs3h6nBrlpFWY4lhohcYa2X/export?format=csv";
          fetch(url)
            .then((res) => res.text())
            .then((csvText) => csv().fromString(csvText))
            .then((jsonData) => {
              setData(jsonData);
            });
        }, []);
        return data;
      }

      function getUniversityListGroupByProgramType(data) {
        const universityListGroupByProgramType = data.reduce(
          (accum, program) => {
            if (accum[program["CÓDIGO_INSTITUCIÓN"]]) {
              accum[program["CÓDIGO_INSTITUCIÓN"]].programs += 1;
              if (
                program["NIVEL_DE_FORMACIÓN"] ===
                NIVEL_FORMACION.especializacion
              ) {
                accum[program["CÓDIGO_INSTITUCIÓN"]].especializacion += 1;
              } else if (
                program["NIVEL_DE_FORMACIÓN"] === NIVEL_FORMACION.maestria
              ) {
                accum[program["CÓDIGO_INSTITUCIÓN"]].maestria += 1;
              } else {
                accum[program["CÓDIGO_INSTITUCIÓN"]].doctorado += 1;
              }
            } else {
              accum[program["CÓDIGO_INSTITUCIÓN"]] = {
                name: program["NOMBRE_INSTITUCIÓN"],
                programs: 1,
                especializacion: 0,
                maestria: 0,
                doctorado: 0,
              };
              if (
                program["NIVEL_DE_FORMACIÓN"] ===
                NIVEL_FORMACION.especializacion
              ) {
                accum[program["CÓDIGO_INSTITUCIÓN"]].especializacion += 1;
              } else if (
                program["NIVEL_DE_FORMACIÓN"] === NIVEL_FORMACION.maestria
              ) {
                accum[program["CÓDIGO_INSTITUCIÓN"]].maestria += 1;
              } else {
                accum[program["CÓDIGO_INSTITUCIÓN"]].doctorado += 1;
              }
            }
            return accum;
          },
          {}
        );
        const universityListSorted = Object.keys(
          universityListGroupByProgramType
        )
          .map((id) => universityListGroupByProgramType[id])
          .sort((a, b) => b.programs - a.programs);
        return universityListSorted;
      }

      function Header() {
        return html`
          <header>
            <h1>
              OFERTA POSGRADOS PARA FORMACIÓN DOCENTE EN EL VALLE DEL CAUCA
            </h1>
          </header>
        `;
      }

      function Menu({ onSelect }) {
        return html`
          <div class="menu">
            <ul>
              <li data-menu-option="universidades" onClick=${onSelect}>
                UNIVERSIDADES
              </li>
              <li data-menu-option="programas" onClick=${onSelect}>
                PROGRAMAS
              </li>
            </ul>
          </div>
        `;
      }

      function ContentModule({ children, title }) {
        return html`
          <div class="content-module">
            <h2>${title}</h2>
            <div class="module-content">${children}</div>
          </div>
        `;
      }

      function UniversityListGroupByPrograms({
        universityListSorted,
        onSelect,
      }) {
        return html`
          <table class="programs-table">
            <thead>
              <tr>
                <th>Universidad</th>
                <th class="tb-programs_th">Especialización</th>
                <th class="tb-programs_th">Maestría</th>
                <th class="tb-programs_th">Doctorado</th>
              </tr>
            </thead>
            <tbody>
              ${universityListSorted.map((university) => {
                return html`
                  <tr>
                    <td>${university.name}</td>
                    <td
                      class="tb-programs-td--counter"
                      onClick=${() =>
                        onSelect([
                          university.name,
                          NIVEL_FORMACION.especializacion,
                        ])}
                    >
                      ${university.especializacion}
                    </td>
                    <td
                      class="tb-programs-td--counter"
                      onClick=${() =>
                        onSelect([university.name, NIVEL_FORMACION.maestria])}
                    >
                      ${university.maestria}
                    </td>
                    <td
                      class="tb-programs-td--counter"
                      onClick=${() =>
                        onSelect([university.name, NIVEL_FORMACION.doctorado])}
                    >
                      ${university.doctorado}
                    </td>
                  </tr>
                `;
              })}
            </tbody>
          </table>
        `;
      }

      function MenuProgramTypeLevel() {
        const { filters, setFilters } = useContext(MainContext);
        const level = filters.program_type;
        return html`
          <div>
            <ul class="menu-program-type-level">
              <li
                class=${!level ? "selected" : ""}
                onClick=${() => setFilters({ program_type: null })}
              >
                Todos
              </li>
              <li
                class=${level === NIVEL_FORMACION.especializacion
                  ? "selected"
                  : ""}
                onClick=${() =>
                  setFilters({
                    program_type: NIVEL_FORMACION.especializacion,
                  })}
              >
                Especialización
              </li>
              <li
                class=${level === NIVEL_FORMACION.maestria ? "selected" : ""}
                onClick=${() =>
                  setFilters({ program_type: NIVEL_FORMACION.maestria })}
              >
                Mestría
              </li>
              <li
                class=${level === NIVEL_FORMACION.doctorado ? "selected" : ""}
                onClick=${() =>
                  setFilters({ program_type: NIVEL_FORMACION.doctorado })}
              >
                Doctorado
              </li>
            </ul>
            <div></div>
          </div>
        `;
      }

      function UniversityList() {
        const { data, setFilters, setMenuOption } = useContext(MainContext);

        console.log("university list ctx: ", data);
        const program_types = Object.keys(NIVEL_FORMACION);
        const universityListGroupByProgramType =
          getUniversityListGroupByProgramType(data);

        // console.log(
        //   "university list SORTED: ",
        //   universityListGroupByProgramType
        // );

        return html`
          <div class="university-list-wrapper">
            <div>
              <${UniversityListGroupByPrograms}
                universityListSorted=${universityListGroupByProgramType}
                onSelect=${(filters) => {
                  setFilters({
                    university: filters[0],
                    program_type: filters[1],
                  });
                  setMenuOption("programas");
                }}
              />
            </div>
          </div>
        `;
      }

      function ProgramList() {
        const { data, setFilters } = useContext(MainContext);

        console.log(" [PROGRAMS] ctx: ", data);

        const universityList = getUniversityListGroupByProgramType(data).map(
          (u) => u.name
        );

        return html`
          <div class="university-list-wrapper">
            <div class="programs_filters-type">
              <div class="u-selection-filter-wrapper">
                <label for="u-select">Escoger universidad:</label>
                <select name="universidades" id="u-select">
                  <option value="">Todas las universidades</option>
                  ${universityList.map(
                    (name) => html`<option value=${name}>${name}</option>`
                  )}
                </select>
              </div>
              <${MenuProgramTypeLevel} />
            </div>
            <div>
              <h3>
                <span>${data.length} programas</span>
              </h3>
            </div>
            <table class="programs-table">
              <thead>
                <tr>
                  <th>Programa</th>
                  <th>Universidad</th>
                  <th>Nivel de formación</th>
                  <th>Ciudad</th>
                  <th>Modalidad</th>
                </tr>
              </thead>
              <tbody>
                ${data.map((programa) => {
                  return html`
                    <tr>
                      <td>${programa["NOMBRE_DEL_PROGRAMA"]}</td>
                      <td>${programa["NOMBRE_INSTITUCIÓN"]}</td>
                      <td>${programa["NIVEL_DE_FORMACIÓN"]}</td>
                      <td>${programa["MUNICIPIO_OFERTA_PROGRAMA"]}</td>
                      <td>${programa["MODALIDAD"]}</td>
                    </tr>
                  `;
                })}
              </tbody>

              <tbody></tbody>
            </table>
          </div>
        `;
      }

      function App() {
        const data = useFetchData();
        const [menuOption, setMenuOption] = useState("universidades");
        const [filters, setFilters] = useState({ ...initialFiltersState });

        const handleOnMenuSelect = (e) => {
          const { menuOption } = e?.currentTarget?.dataset ?? {};
          if (menuOption) {
            setMenuOption(menuOption);
            if (menuOption === "universidades") {
              setFilters({ ...initialFiltersState });
            }
          }
        };

        const filterType = {
          university: (program, query) =>
            program["NOMBRE_INSTITUCIÓN"] === query,
          program_type: (program, query) =>
            program["NIVEL_DE_FORMACIÓN"] === query,
          interest_area: (program, query) =>
            program["CÓDIGO_INSTITUCIÓN"] === query,
          modalidad: (program, query) =>
            program["CÓDIGO_INSTITUCIÓN"] === query,
          location: (program, query) => program["CÓDIGO_INSTITUCIÓN"] === query,
        };

        const filterData = (data, filters) => {
          let filteredData = [...data];
          Object.keys(filters).forEach((filter) => {
            const query = filters[filter];
            if (query) {
              filteredData = filteredData.filter((program) =>
                filterType[filter](program, query)
              );
            }
          });
          return filteredData;
        };

        const filteredData = filterData(data, filters);
        console.log("applied filters: ", filteredData);

        const store = {
          data: filteredData,
          filters,
          setFilters,
          setMenuOption,
        };
        console.log("app filter state: ", filters);
        return html`
          <div class="main-wrapper">
            <${Header} />

            <${MainContext.Provider} value=${store}>
              <main>
                <div><${Menu} onSelect=${handleOnMenuSelect} /></div>
                <div class="content">
                  <${ContentModule}
                    title=${menuOption === "universidades"
                      ? "UNIVERSIDADES"
                      : "PROGRAMAS"}
                  >
                    <${menuOption === "universidades"
                      ? UniversityList
                      : ProgramList} />
                  <//>
                </div>
              </main>
            <//>
          </div>
        `;
      }

      render(html`<${App} />`, document.body);
    </script>
  </body>
</html>
